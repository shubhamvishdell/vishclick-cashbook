<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>VishClick : Design Studio</title>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; padding: 10px; max-width: 900px; margin: auto; color: #333; }
        .auth-section { margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; min-height: 40px; }
        #app-container { display: none; }
        #user-info { font-weight: bold; }
        button { margin: 5px 0; padding: 10px 15px; cursor: pointer; border-radius: 8px; border: 1px solid #ccc; background-color: #f0f0f0; font-size: 14px; }
        button:hover { background-color: #e0e0e0; }
        input, select { box-sizing: border-box; padding: 10px; border-radius: 8px; border: 1px solid #ccc; width: 100%; margin-bottom: 10px; font-size: 14px; }
        .book-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 15px; border: 1px solid #eee; margin-top: 8px; border-radius: 8px; }
        .book-item:hover { background-color: #f9f9f9; }
        .book-name { flex-grow: 1; cursor: pointer; display:flex; align-items:center; gap:10px; }
        .book-delete-btn { background-color: #ffeded; color: #dc3545; border: 1px solid #ffb8b8; padding: 6px 12px; font-size: 12px; margin-left: 15px; }
        .book-delete-btn:hover { background-color: #dc3545; color: white; }
        .delete-btn { color: red; cursor: pointer; border: none; background: none; font-size: 1.1em; padding: 0 8px; }
        .cash-in { color: #28a745; font-weight: bold; }
        .cash-out { color: #dc3545; font-weight: bold; }
        #summary { border: 1px solid #ccc; padding: 15px; margin-bottom: 10px; border-radius: 8px; background-color: #fafafa; display: flex; justify-content: space-between; }
        table { border-collapse: collapse; width: 100%; margin-top: 15px; }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
        th { background-color: #f2f2f2; }
        .balance-badge { padding: 6px 10px; border-radius: 8px; font-weight: bold; }
        .balance-positive { background: #e6ffec; color: #0b7a3a; border: 1px solid #c8f1d1; }
        .balance-negative { background: #fff0f0; color: #a00; border: 1px solid #f2c7c7; }
        /* Edit modal (keeps UI minimal) */
        #editModal { position: fixed; left: 0; top:0; right:0; bottom:0; display:none; align-items:center; justify-content:center; background: rgba(0,0,0,0.4); z-index: 9999; }
        #editModal .card { width: 420px; background: #fff; padding: 16px; border-radius: 10px; box-shadow: 0 8px 24px rgba(0,0,0,0.15); }
        #editModal h4 { margin: 0 0 8px 0; }
        .small { font-size: 12px; padding:6px 8px; border-radius:6px; }
        .inline-btns { display:flex; gap:8px; align-items:center; }
    </style>
</head>
<body>
    <h2 style="text-align: center; background-color: navy; color: white; padding: 10px;"><strong>VishClick : Design Studio</strong></h2>

    <div class="auth-section">
        <div id="g_id_signin"></div>
        <div id="user-info" style="display: none;"></div>
        <button id="signout_button" style="display: none;">Sign Out</button>
    </div>
    <hr>

    <div id="app-container">
        <div id="homeScreen">
            <h3>My Cashbooks</h3>
            <form id="addBookForm">
                <input type="text" id="newBookName" placeholder="New cashbook name" required>
                <button type="submit">Add New Book</button>
            </form>
            <div id="bookList"></div>
        </div>

        <div id="detailsScreen" style="display: none;">
            <button id="backButton">&larr; Back to Home</button>
            <h2 id="bookTitle" style="background-color: #e6e6fa; padding: 8px;"></h2>
            <h3>Add New Entry</h3>
            <form id="entryForm" onsubmit="return false;">
                <input type="date" id="dateInput"> <input type="time" id="timeInput">
                <select id="modeInput">
                    <option value="Cash">Cash</option> <option value="Online">Online</option>
                </select>
                <input type="number" id="amountInput" placeholder="Amount (₹)" required>
                <input type="text" id="remarkInput" placeholder="Enter details" required>
                <div class="inline-btns">
                    <button type="button" id="cashInButton">CASH IN</button>
                    <button type="button" id="cashOutButton">CASH OUT</button>
                </div>
            </form>
            <hr>
            <div id="summary">
                <div>Total In (+): <strong id="totalInDisplay" class="cash-in">0.00</strong></div>
                <div>Total Out (-): <strong id="totalOutDisplay" class="cash-out">0.00</strong></div>
                <div>Net Balance: <strong id="netBalanceDisplay">0.00</strong></div>
            </div>
            <button type="button" id="exportPdfButton">Export Report as PDF</button>
            <h3>Entries</h3>
            <table>
                <thead>
                    <tr><th>Date</th><th>Remark</th><th>Mode</th><th>Cash In</th><th>Cash Out</th><th>Balance</th><th>Actions</th></tr>
                </thead>
                <tbody id="entryList"></tbody>
            </table>
        </div>
    </div>

    <!-- Edit modal -->
    <div id="editModal">
        <div class="card">
            <h4>Edit Entry</h4>
            <label>Date</label>
            <input type="date" id="editDate">
            <label>Time</label>
            <input type="time" id="editTime">
            <label>Mode</label>
            <select id="editMode"><option>Cash</option><option>Online</option></select>
            <label>Amount (₹)</label>
            <input type="number" id="editAmount">
            <label>Remark</label>
            <input type="text" id="editRemark">
            <div style="display:flex; justify-content:flex-end; gap:8px; margin-top:8px;">
                <button id="cancelEdit" class="small">Cancel</button>
                <button id="saveEdit" class="small">Save</button>
            </div>
        </div>
    </div>

    <script>
        const CLIENT_ID = '276544229541-udlegtaa830stnsksmlspovakis9m337.apps.googleusercontent.com';
        const SCOPES = 'https://www.googleapis.com/auth/drive.file';
        const DATA_FILENAME = 'vishclick-cashbook-data.json';

        // DOM references
        const gIdSignin = document.getElementById('g_id_signin');
        const appContainer = document.getElementById('app-container');
        const homeScreen = document.getElementById('homeScreen');
        const detailsScreen = document.getElementById('detailsScreen');
        const bookList = document.getElementById('bookList');
        const addBookForm = document.getElementById('addBookForm');
        const newBookNameInput = document.getElementById('newBookName');
        const signoutButton = document.getElementById('signout_button');
        const userInfo = document.getElementById('user-info');
        const backButton = document.getElementById('backButton');
        const bookTitle = document.getElementById('bookTitle');
        const dateInput = document.getElementById('dateInput');
        const timeInput = document.getElementById('timeInput');
        const modeInput = document.getElementById('modeInput');
        const amountInput = document.getElementById('amountInput');
        const remarkInput = document.getElementById('remarkInput');
        const cashInButton = document.getElementById('cashInButton');
        const cashOutButton = document.getElementById('cashOutButton');
        const totalInDisplay = document.getElementById('totalInDisplay');
        const totalOutDisplay = document.getElementById('totalOutDisplay');
        const netBalanceDisplay = document.getElementById('netBalanceDisplay');
        const entryList = document.getElementById('entryList');
        const exportPdfButton = document.getElementById('exportPdfButton');

        // Edit modal elements
        const editModal = document.getElementById('editModal');
        const editDate = document.getElementById('editDate');
        const editTime = document.getElementById('editTime');
        const editMode = document.getElementById('editMode');
        const editAmount = document.getElementById('editAmount');
        const editRemark = document.getElementById('editRemark');
        const saveEdit = document.getElementById('saveEdit');
        const cancelEdit = document.getElementById('cancelEdit');

        let tokenClient, allData = {}, dataFileId = null, currentBookName = null;
        // For editing
        let editingEntryId = null;

        // ------------------ local backup helpers -----------------
        function saveToLocalBackup() {
            try {
                localStorage.setItem('vc_allData', JSON.stringify(allData || {}));
                if (dataFileId) localStorage.setItem('vc_dataFileId', dataFileId);
            } catch (e) { console.warn('Local backup failed', e); }
        }
        function loadFromLocalBackup() {
            try {
                const t = localStorage.getItem('vc_allData');
                const id = localStorage.getItem('vc_dataFileId');
                if (t) {
                    allData = JSON.parse(t) || {};
                }
                if (id) dataFileId = id;
            } catch (e) { console.warn('Failed to load local backup', e); }
        }
        // Load early for instant UI on refresh
        loadFromLocalBackup();

        window.onload = function() {
            if (window.google && google.accounts && google.accounts.id) {
                google.accounts.id.initialize({ client_id: CLIENT_ID, callback: handleCredentialResponse });
                google.accounts.id.renderButton(gIdSignin, { theme: 'outline', size: 'large' });
                tokenClient = google.accounts.oauth2.initTokenClient({ client_id: CLIENT_ID, scope: SCOPES, callback: handleTokenResponse });
            }
            // If local data exists, show UI quickly (user still needs to sign in for Drive)
            if (Object.keys(allData).length > 0) {
                updateUiOnLogin(true); // local-only render
            }
        };

        function handleCredentialResponse(response) { 
            if (tokenClient) tokenClient.requestAccessToken(); 
        }
        
        function handleTokenResponse(tokenResponse) {
            if (tokenResponse && tokenResponse.access_token) {
                gapi.load('client', () => initGapiClient(tokenResponse));
            }
        }
        
        function initGapiClient(tokenResponse) {
            gapi.client.init({}).then(() => {
                gapi.client.setToken(tokenResponse);
                gapi.client.load('drive', 'v3', findDataFile);
            }).catch(err => { console.warn(err); });
        }

        signoutButton.addEventListener('click', async () => {
            // Save locally before sign out
            saveToLocalBackup();
            // Try to save to Drive (best-effort)
            if (dataFileId) await saveDataFile();
            if (google && google.accounts && google.accounts.id) google.accounts.id.disableAutoSelect();
            updateUiOnLogout();
        });

        // ------------------ Drive handling (safer) -----------------
        function findDataFile() {
            // Try stored ID first
            if (dataFileId) {
                gapi.client.drive.files.get({ fileId: dataFileId, fields: 'id,name' })
                .then(() => { readFile(dataFileId); })
                .catch(err => {
                    console.warn('Stored fileId invalid or inaccessible, falling back to search.', err);
                    listFilesByName();
                });
            } else {
                listFilesByName();
            }

            function listFilesByName() {
                gapi.client.drive.files.list({
                    q: `name='${DATA_FILENAME}' and trashed=false`,
                    fields: 'files(id,name)', spaces: 'drive'
                }).then(res => {
                    if (res.result.files && res.result.files.length > 0) {
                        dataFileId = res.result.files[0].id;
                        try { localStorage.setItem('vc_dataFileId', dataFileId); } catch(e) {}
                        readFile(dataFileId);
                    } else {
                        // create file but initialize with local backup if available
                        createFile();
                    }
                }).catch(err => {
                    console.warn('Error listing files, will try to use local backup only.', err);
                    updateUiOnLogin(true);
                });
            }
        }

        function readFile(fileId) {
            gapi.client.drive.files.get({ fileId, alt: 'media' }).then(res => {
                try {
                    // some gapi versions put data in res.result or res.body
                    const parsed = res.result || (res.body ? JSON.parse(res.body) : null);
                    if (parsed && typeof parsed === 'object' && Object.keys(parsed).length > 0) allData = parsed;
                } catch (e) {
                    console.warn('Failed parsing drive file content, using local backup if available', e);
                }
                saveToLocalBackup();
                updateUiOnLogin();
            }).catch(err => {
                console.warn('Failed to read file from Drive, using local backup', err);
                loadFromLocalBackup();
                updateUiOnLogin(true);
            });
        }

        function createFile() {
            // create empty or with local content
            gapi.client.drive.files.create({ resource: { name: DATA_FILENAME, mimeType: 'application/json' }, fields: 'id' })
            .then(res => { dataFileId = res.result.id; try { localStorage.setItem('vc_dataFileId', dataFileId); } catch(e){}; 
                // upload initial content (local)
                uploadFileContent(dataFileId, JSON.stringify(allData || {})).then(() => saveToLocalBackup()).catch(() => {});
                updateUiOnLogin();
            }).catch(err => {
                console.warn('Could not create Drive file', err);
                updateUiOnLogin(true);
            });
        }

        async function uploadFileContent(fileId, contentString) {
            const blob = new Blob([contentString], { type: 'application/json' });
            const form = new FormData();
            form.append('metadata', new Blob([JSON.stringify({ mimeType: 'application/json' })], { type: 'application/json' }));
            form.append('file', blob);

            const token = gapi.client.getToken && gapi.client.getToken().access_token;
            if (!token) throw new Error('No access token');

            const res = await fetch(`https://www.googleapis.com/upload/drive/v3/files/${fileId}?uploadType=multipart`, {
                method: 'PATCH',
                headers: { 'Authorization': `Bearer ${token}` },
                body: form
            });
            if (!res.ok) throw new Error('Upload failed: ' + res.statusText);
            return res;
        }

        async function saveDataFile() {
            // Always keep a local backup first
            saveToLocalBackup();

            if (!dataFileId) {
                // try to create if authorized
                const token = gapi.client.getToken && gapi.client.getToken().access_token;
                if (token) {
                    try { createFile(); } catch(e) { console.warn(e); }
                } else {
                    console.warn('No dataFileId and no token - saved locally only.');
                }
                return;
            }
            const token = gapi.client.getToken && gapi.client.getToken().access_token;
            if (!token) {
                console.warn('No access token, saved locally only.');
                return;
            }
            const content = JSON.stringify(allData || {});
            try {
                await uploadFileContent(dataFileId, content);
            } catch (err) {
                console.warn('Drive save failed, will keep local backup. Error:', err);
            }
        }

        // beforeunload best-effort save
        window.addEventListener('beforeunload', (e) => {
            saveToLocalBackup();
            // try sendBeacon (best-effort) — only for local backup; Drive upload via sendBeacon not reliable for auth
        });

        // ------------------ UI helpers -----------------
        function showScreen(screen) {
            homeScreen.style.display = screen === 'home' ? 'block' : 'none';
            detailsScreen.style.display = screen === 'details' ? 'block' : 'none';
        }

        function showDetailsScreen(bookName) {
            currentBookName = bookName;
            bookTitle.textContent = bookName;
            const now = new Date();
            dateInput.value = now.toISOString().slice(0, 10);
            timeInput.value = now.toTimeString().slice(0, 5);
            renderEntries();
            showScreen('details');
        }

        backButton.addEventListener('click', () => {
            editingEntryId = null;
            showScreen('home');
            renderBookList();
        });

        function updateUiOnLogin(localOnly = false) {
            gIdSignin.style.display = 'none';
            signoutButton.style.display = 'block';
            userInfo.style.display = 'block';
            userInfo.textContent = localOnly ? 'Signed in (local data)' : 'Signed in';
            appContainer.style.display = 'block';
            showScreen('home');
            renderBookList();
        }

        function updateUiOnLogout() {
            gIdSignin.style.display = 'block';
            signoutButton.style.display = 'none';
            userInfo.style.display = 'none';
            appContainer.style.display = 'none';
            // Keep allData in localStorage so user doesn't lose data when they sign out
            // allData = {}; dataFileId = null; // don't clear local backup
        }

        // ------------------ Book list + balance display -----------------
        function computeBookTotals(bookName) {
            const entries = (allData[bookName] || []);
            let totalIn = 0, totalOut = 0;
            entries.forEach(e => {
                if (e.type === 'in') totalIn += Number(e.amount || 0);
                else totalOut += Number(e.amount || 0);
            });
            return { totalIn, totalOut, net: totalIn - totalOut };
        }

        function renderBookList() {
            bookList.innerHTML = '';
            Object.keys(allData).forEach(bookName => {
                const bookDiv = document.createElement('div');
                bookDiv.className = 'book-item';

                // Name + balance
                const nameSpan = document.createElement('div');
                nameSpan.className = 'book-name';
                nameSpan.onclick = () => showDetailsScreen(bookName);

                const title = document.createElement('span');
                title.textContent = bookName;
                title.style.cursor = 'pointer';

                const totals = computeBookTotals(bookName);
                const balanceBadge = document.createElement('span');
                balanceBadge.className = 'balance-badge ' + (totals.net >= 0 ? 'balance-positive' : 'balance-negative');
                balanceBadge.textContent = (totals.net >= 0 ? '+ ' : '- ') + Math.abs(totals.net).toFixed(2);
                balanceBadge.title = 'Net balance';

                nameSpan.appendChild(title);
                nameSpan.appendChild(balanceBadge);

                // Delete button
                const deleteBtn = document.createElement('button');
                deleteBtn.textContent = 'Delete';
                deleteBtn.className = 'book-delete-btn';
                deleteBtn.onclick = (e) => {
                    e.stopPropagation();
                    deleteBook(bookName);
                };

                bookDiv.appendChild(nameSpan);
                bookDiv.appendChild(deleteBtn);
                bookList.appendChild(bookDiv);
            });

            // If no books, show hint
            if (Object.keys(allData).length === 0) {
                bookList.innerHTML = '<div style="margin-top:12px; color:#666;">No cashbooks yet. Create one above to start tracking.</div>';
            }
        }

        function deleteBook(bookName) {
            const confirmation = prompt(`This action cannot be undone.\nTo permanently delete the cashbook "${bookName}", please type its name below:`);
            if (confirmation === null) return;
            if (confirmation.trim() === bookName) {
                delete allData[bookName];
                saveToLocalBackup();
                saveDataFile();
                renderBookList();
                alert(`Cashbook "${bookName}" has been deleted.`);
            } else {
                alert('The name you entered did not match. Deletion cancelled.');
            }
        }

        addBookForm.addEventListener('submit', e => {
            e.preventDefault();
            const newBookName = newBookNameInput.value.trim();
            if (newBookName && !allData[newBookName]) {
                allData[newBookName] = [];
                newBookNameInput.value = '';
                renderBookList();
                saveToLocalBackup();
                saveDataFile();
            } else { alert('Book name already exists or is invalid.'); }
        });

        // ------------------ Entries: add / render / delete / edit -----------------
        function addEntry(type){
            const amount = parseFloat(amountInput.value);
            if (!currentBookName) return alert('Select a book first.');
            if (isNaN(amount) || amount <= 0) return alert('Enter a valid amount.');
            if (remarkInput.value.trim() === '') return alert('Enter details/remark.');
            const dateVal = dateInput.value || new Date().toISOString().slice(0, 10);
            const timeVal = timeInput.value || new Date().toTimeString().slice(0, 5);
            const newEntry = { id: Date.now() + Math.random(), date: `${dateVal} ${timeVal}`, remark: remarkInput.value.trim(), mode: modeInput.value, amount: Number(amount), type };
            if (!allData[currentBookName]) allData[currentBookName] = [];
            allData[currentBookName].push(newEntry);
            renderEntries();
            saveToLocalBackup();
            saveDataFile();
            amountInput.value = ''; remarkInput.value = '';
        }

        function renderEntries(){
            if (!currentBookName) return;
            const originalEntries = allData[currentBookName] || [];
            const entries = originalEntries.slice().sort((a, b) => new Date(a.date) - new Date(b.date));
            let totalIn = 0, totalOut = 0;
            const runningBalances = [];
            let running = 0;
            entries.forEach(e => {
                if (e.type === 'in') totalIn += Number(e.amount || 0);
                else totalOut += Number(e.amount || 0);
                running += (e.type === 'in' ? Number(e.amount || 0) : -Number(e.amount || 0));
                runningBalances.push(running);
            });

            entryList.innerHTML = '';
            for(let i = entries.length - 1; i >= 0; i--) {
                const e = entries[i];
                const bal = runningBalances[i];
                const row = entryList.insertRow();
                row.insertCell(0).textContent = new Date(e.date).toLocaleString();
                row.insertCell(1).textContent = e.remark;
                row.insertCell(2).textContent = e.mode;
                const ci = row.insertCell(3), co = row.insertCell(4);
                if (e.type === 'in') { ci.textContent = Number(e.amount).toFixed(2); ci.className = 'cash-in'; co.textContent = '-'; }
                else { co.textContent = Number(e.amount).toFixed(2); co.className = 'cash-out'; ci.textContent = '-'; }
                row.insertCell(5).textContent = bal.toFixed(2);
                const actionsCell = row.insertCell(6);

                // Edit button
                const editBtn = document.createElement('button');
                editBtn.textContent = 'Edit';
                editBtn.className = 'small';
                editBtn.onclick = () => openEditModal(e.id);

                // Delete button
                const delBtn = document.createElement('button');
                delBtn.textContent = 'X';
                delBtn.className = 'delete-btn';
                delBtn.onclick = () => {
                    if (confirm('Are you sure you want to delete this entry?')) {
                        const idx = allData[currentBookName].findIndex(x => x.id === e.id);
                        if (idx > -1) { allData[currentBookName].splice(idx, 1); renderEntries(); saveToLocalBackup(); saveDataFile(); }
                    }
                };

                actionsCell.appendChild(editBtn);
                actionsCell.appendChild(delBtn);
            }
            totalInDisplay.textContent = totalIn.toFixed(2);
            totalOutDisplay.textContent = totalOut.toFixed(2);
            netBalanceDisplay.textContent = (totalIn - totalOut).toFixed(2);

            // Also update home list balances live
            renderBookList();
        }

        cashInButton.addEventListener('click', () => addEntry('in'));
        cashOutButton.addEventListener('click', () => addEntry('out'));

        // ------------------ Edit modal logic -----------------
        function openEditModal(entryId) {
            const entry = (allData[currentBookName] || []).find(x => x.id === entryId);
            if (!entry) return alert('Entry not found');
            editingEntryId = entryId;
            // populate modal
            const [d,t] = entry.date.split(' ');
            editDate.value = d;
            editTime.value = t || '00:00';
            editMode.value = entry.mode || 'Cash';
            editAmount.value = entry.amount;
            editRemark.value = entry.remark;
            editModal.style.display = 'flex';
        }
        cancelEdit.addEventListener('click', () => { editingEntryId = null; editModal.style.display = 'none'; });
        saveEdit.addEventListener('click', () => {
            if (!editingEntryId) return;
            const amount = parseFloat(editAmount.value);
            if (isNaN(amount) || amount <= 0) return alert('Enter a valid amount.');
            if (editRemark.value.trim() === '') return alert('Enter details/remark.');

            const entry = (allData[currentBookName] || []).find(x => x.id === editingEntryId);
            if (!entry) return alert('Entry not found (maybe deleted)');

            entry.date = `${editDate.value} ${editTime.value}`;
            entry.mode = editMode.value;
            entry.amount = Number(amount);
            entry.remark = editRemark.value.trim();

            editingEntryId = null;
            editModal.style.display = 'none';
            renderEntries();
            saveToLocalBackup();
            saveDataFile();
        });

        // ------------------ PDF export (unchanged but uses current computed order) -----------------
        exportPdfButton.addEventListener('click', () => {
            const originalEntries = allData[currentBookName] || [];
            if (!originalEntries || originalEntries.length === 0) {
                return alert('No entries to export!');
            }

            const entries = originalEntries.slice().sort((a, b) => new Date(a.date) - new Date(b.date));

            let running = 0, totalIn = 0, totalOut = 0;
            const calculatedRows = entries.map(e => {
                if (e.type === 'in') { totalIn += Number(e.amount || 0); running += Number(e.amount || 0); } 
                else { totalOut += Number(e.amount || 0); running -= Number(e.amount || 0); }
                return {
                    date: new Date(e.date).toLocaleString(), remark: e.remark, mode: e.mode,
                    cashIn: e.type === 'in' ? Number(e.amount).toFixed(2) : '-',
                    cashOut: e.type === 'out' ? Number(e.amount).toFixed(2) : '-',
                    balance: running.toFixed(2)
                };
            });

            const rowsForPdf = calculatedRows.slice().reverse();
            const tableBody = rowsForPdf.map(r => [r.date, r.remark, r.mode, r.cashIn, r.cashOut, r.balance]);

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');
            doc.setFont('helvetica');

            const pageWidth = doc.internal.pageSize.getWidth();
            const margin = 10;

            doc.setFillColor(0, 38, 77); doc.rect(0, 0, pageWidth, 12, 'F');
            doc.setTextColor(255, 255, 255); doc.setFontSize(16);
            doc.text("VishClick : Design Studio", pageWidth / 2, 8, { align: 'center' });

            doc.setFillColor(230, 230, 250); doc.rect(0, 12, pageWidth, 10, 'F');
            doc.setTextColor(0); doc.setFontSize(12); doc.setFont(undefined, 'bold');
            doc.text(`Book: ${currentBookName}`, pageWidth / 2, 19, { align: 'center' });

            const totalWidth = 60, gap = 5, totalsY = 30, totalStartX = 20;
            doc.setFontSize(9); doc.setFont(undefined, 'bold');
            doc.setFillColor(220, 255, 220); doc.rect(totalStartX, totalsY, totalWidth, 8, 'F');
            doc.setTextColor(0, 128, 0); doc.text(`Total In: ${totalIn.toFixed(2)}`, totalStartX + 3, totalsY + 6);
            doc.setFillColor(255, 220, 220); doc.rect(totalStartX + totalWidth + gap, totalsY, totalWidth, 8, 'F');
            doc.setTextColor(220, 0, 0); doc.text(`Total Out: ${totalOut.toFixed(2)}`, totalStartX + totalWidth + gap + 3, totalsY + 6);
            doc.setFillColor(220, 220, 255); doc.rect(totalStartX + (totalWidth + gap) * 2, totalsY, totalWidth, 8, 'F');
            doc.setTextColor(75, 0, 130); doc.text(`Net Balance: ${(totalIn - totalOut).toFixed(2)}`, totalStartX + (totalWidth + gap) * 2 + 3, totalsY + 6);
            
            doc.autoTable({
                head: [['Date', 'Remark', 'Mode', 'Cash In', 'Cash Out', 'Balance']], body: tableBody,
                startY: totalsY + 14, margin: { left: margin, right: margin }, styles: { fontSize: 9, cellPadding: 2.5 },
                headStyles: { fillColor: [41, 128, 185], textColor: 255, halign: 'center' },
                columnStyles: {
                    0: { cellWidth: 35 }, 1: { cellWidth: 'auto' }, 2: { cellWidth: 20, halign: 'center' },
                    3: { cellWidth: 22, halign: 'right', textColor: [0, 128, 0] },
                    4: { cellWidth: 22, halign: 'right', textColor: [220, 0, 0] },
                    5: { cellWidth: 22, halign: 'right' }
                }, theme: 'grid'
            });
            doc.save(`${currentBookName}-report.pdf`);
        });

        // Initial render if local data present
        renderBookList();
    </script>
</body>
</html>
